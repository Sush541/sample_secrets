name: Secret Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Gitleaks scan
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --report-format json --report-path gitleaks-report.json

      - name: Generate HTML report from Gitleaks JSON
        id: generate_report
        run: |
          node -e "
          const fs = require('fs');
          const data = JSON.parse(fs.readFileSync('gitleaks-report.json', 'utf8'));
          if(data.length === 0){
            fs.writeFileSync('gitleaks-report.html', '<p>No leaks detected âœ…</p>');
          } else {
            let html = '<table border=1><tr><th>File</th><th>Line</th><th>Secret</th><th>Rule</th></tr>';
            data.forEach(d => {
              html += `<tr><td>${d.file}</td><td>${d.line}</td><td>${d.secret}</td><td>${d.rule}</td></tr>`;
            });
            html += '</table>';
            fs.writeFileSync('gitleaks-report.html', html);
          }
          const htmlBody = fs.readFileSync('gitleaks-report.html', 'utf8').replace(/\n/g,'');
          console.log(`::set-output name=html_body::${htmlBody}`);
          "

      - name: Send email with scan results
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Gitleaks Scan Results for ${{ github.repository }}"
          to: ${{ secrets.TO_EMAIL }}
          from: ${{ secrets.FROM_EMAIL }}
          content_type: text/html
          body: ${{ steps.generate_report.outputs.html_body }}
